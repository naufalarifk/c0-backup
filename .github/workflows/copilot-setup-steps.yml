name: Copilot Setup Steps
on:
  workflow_dispatch:

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Install system dependencies for E2E testing
        run: |
          # Update package list
          sudo apt-get update

          # Install Redis server for E2E tests
          sudo apt-get install -y redis-server

          # Install Mailpit for E2E email testing
          INSTALL_PATH=/usr/bin sudo sh < <(curl -sL https://raw.githubusercontent.com/axllent/mailpit/develop/install.sh)

      - name: Verify E2E test dependencies
        run: |
          # Check Redis is available
          redis-server --version

          # Check Mailpit is available
          mailpit --version

          # Check Node.js and pnpm versions
          node --version
          pnpm --version

      - name: Setup test environment variables
        run: |
          echo "NODE_OPTIONS=--import tsx --experimental-vm-modules" >> $GITHUB_ENV
