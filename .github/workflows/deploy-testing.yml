name: Deploy to testing

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-testing-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to testing server
    runs-on: ubuntu-24.04
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup SSH
        run: |
          mkdir -p $HOME/.ssh
          echo "$SSH_PRIVATE_KEY" > $HOME/.ssh/id_ed25519
          chmod 600 $HOME/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> $HOME/.ssh/known_hosts 2>/dev/null || true
        shell: bash

      - name: Rsync repository to remote server
        run: |
          rsync -avz --delete \
            --exclude-from=".gitignore" \
            --exclude ".DS_Store" \
            --exclude ".env*" \
            --exclude ".git/" \
            --exclude ".local/" \
            --exclude ".nyc_output/" \
            --exclude ".temp/" \
            --exclude ".vscode/" \
            --exclude "*.log" \
            --exclude "coverage/" \
            --exclude "node_modules/" \
            --exclude "test-results/" \
            -e "ssh -i $HOME/.ssh/id_ed25519 -p $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60" \
            ./ "$SSH_USER@$SSH_HOST:/opt/cg-backend/"
        shell: bash
        timeout-minutes: 10

      - name: Deploy with systemd
        run: |
          ssh -i $HOME/.ssh/id_ed25519 -p "$SSH_PORT" -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60 "$SSH_USER@$SSH_HOST" << 'EOF'
            set -euo pipefail
            cd /opt/cg-backend
            
            # Export commit SHA for logging
            export GITHUB_SHA="${{ github.sha }}"
            
            echo "üöÄ Starting deployment of commit $GITHUB_SHA"
            
            # Install dependencies
            echo "üì¶ Installing dependencies..."
            pnpm install --frozen-lockfile --ignore-scripts
            
            # Build the application
            echo "üî® Building application..."
            pnpm run build
            
            # Restart the service
            echo "üîÑ Restarting cg-backend service..."
            systemctl restart cg-backend
            
            # Wait for service to be running
            echo "‚è≥ Waiting for service to start..."
            timeout 60 bash -c 'until systemctl is-active --quiet cg-backend; do sleep 2; echo "Waiting for service to be active..."; done'
            
            # Verify deployment
            echo "üîç Verifying deployment..."
            systemctl status cg-backend
            
            # Test health endpoint
            echo "üß™ Testing health endpoint..."
            timeout 30 bash -c 'until curl -sf http://localhost:3000/api/health >/dev/null; do sleep 2; echo "Waiting for API to respond..."; done'
            
            echo "‚úÖ Deployment completed successfully!"
          EOF
        shell: bash
        timeout-minutes: 15

      - name: Cleanup
        if: always()
        run: |
          rm -f $HOME/.ssh/id_ed25519
        shell: bash

      - name: Notify deployment result
        if: always()
        run: |
          if [ ${{ job.status }} = 'success' ]; then
            echo "‚úÖ Deployment to testing completed successfully"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
          else
            echo "‚ùå Deployment to testing failed"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Check the logs above for details"
          fi
        shell: bash
