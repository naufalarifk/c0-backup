name: Deploy to testing

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-testing-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to testing server
    runs-on: ubuntu-24.04
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      SSH_HOST_FINGERPRINT: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup SSH
        run: |
          mkdir -p $HOME/.ssh
          echo "$SSH_PRIVATE_KEY" > $HOME/.ssh/id_ed25519
          chmod 600 $HOME/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> $HOME/.ssh/known_hosts 2>/dev/null || true
        shell: bash

      - name: Rsync repository to remote server
        run: |
          rsync -avz --delete \
            --exclude-from=".gitignore" \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".env*" \
            --exclude "*.log" \
            --exclude ".temp/" \
            --exclude ".vscode/" \
            --exclude ".DS_Store" \
            --exclude "coverage/" \
            --exclude ".nyc_output/" \
            -e "ssh -i $HOME/.ssh/id_ed25519 -p $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60" \
            ./ "$SSH_USER@$SSH_HOST:/root/cg/"
        shell: bash
        timeout-minutes: 10

      - name: Deploy Docker Compose
        run: |
          ssh -i $HOME/.ssh/id_ed25519 -p "$SSH_PORT" -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60 "$SSH_USER@$SSH_HOST" << 'EOF'
            set -euo pipefail
            cd /root/cg
            
            # Stop existing containers gracefully
            docker compose --file docker-compose.testing.yml down --timeout 30
            
            # Build and start new containers
            docker compose --file docker-compose.testing.yml up --build --force-recreate --detach
            
            # Wait for services to be healthy
            echo "Waiting for services to be healthy..."
            timeout 300 bash -c 'until docker compose --file docker-compose.testing.yml ps | grep -q "healthy\|running"; do sleep 5; done'
            
            # Clean up unused Docker resources
            docker system prune -f
            
            # Show deployment status
            echo "Deployment completed successfully"
            docker compose --file docker-compose.testing.yml ps
          EOF
        shell: bash
        timeout-minutes: 15

      - name: Verify deployment
        run: |
          ssh -i $SSH_KEY_PATH -p "$SSH_PORT" -o StrictHostKeyChecking=yes -o ConnectTimeout=30 "$SSH_USER@$SSH_HOST" << 'EOF'
            set -euo pipefail
            cd /root/cg
            
            # Check if containers are running
            if ! docker compose --file docker-compose.testing.yml ps | grep -q "Up"; then
              echo "Error: Some containers are not running"
              docker compose --file docker-compose.testing.yml ps
              exit 1
            fi
            
            # Check API health endpoint
            if ! curl -f --max-time 30 http://localhost:3100/api/health; then
              echo "Error: API health check failed"
              exit 1
            fi
            
            echo "✅ Deployment verification successful"
          EOF
        shell: bash
        timeout-minutes: 5

      - name: Cleanup
        if: always()
        run: |
          rm -f $SSH_KEY_PATH
        shell: bash

      - name: Notify deployment result
        if: always()
        run: |
          if [ ${{ job.status }} = 'success' ]; then
            echo "✅ Deployment to testing completed successfully"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
          else
            echo "❌ Deployment to testing failed"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Check the logs above for details"
          fi
        shell: bash
