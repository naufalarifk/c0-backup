name: Deploy to testing

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy-testing-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to testing server
    runs-on: ubuntu-24.04
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup SSH
        run: |
          mkdir -p $HOME/.ssh
          echo "$SSH_PRIVATE_KEY" > $HOME/.ssh/id_ed25519
          chmod 600 $HOME/.ssh/id_ed25519
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> $HOME/.ssh/known_hosts 2>/dev/null || true
        shell: bash

      - name: Rsync repository to remote server
        run: |
          rsync -avz --delete \
            --exclude-from=".gitignore" \
            --exclude ".git/" \
            --exclude "node_modules/" \
            --exclude ".env*" \
            --exclude "*.log" \
            --exclude ".temp/" \
            --exclude ".vscode/" \
            --exclude ".DS_Store" \
            --exclude "coverage/" \
            --exclude ".nyc_output/" \
            -e "ssh -i $HOME/.ssh/id_ed25519 -p $SSH_PORT -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60" \
            ./ "$SSH_USER@$SSH_HOST:/root/cg/"
        shell: bash
        timeout-minutes: 10

      - name: Deploy with Zero Downtime
        run: |
          ssh -i $HOME/.ssh/id_ed25519 -p "$SSH_PORT" -o StrictHostKeyChecking=yes -o ConnectTimeout=30 -o ServerAliveInterval=60 "$SSH_USER@$SSH_HOST" << 'EOF'
            set -euo pipefail
            cd /root/cg
            
            # Export commit SHA for deployment labeling
            export GITHUB_SHA="${{ github.sha }}"
            
            # Check if this is the first deployment
            if ! docker compose -f docker-compose.testing.yml ps api -q >/dev/null 2>&1; then
              echo "üöÄ First deployment detected, performing initial setup..."
              docker compose -f docker-compose.testing.yml up --build -d
              
              # Wait for initial services to be healthy
              echo "‚è≥ Waiting for services to be healthy..."
              timeout 300 bash -c 'until docker compose -f docker-compose.testing.yml ps --format json | jq -r ".[] | select(.Service == \"api\") | .Health" | grep -q "healthy"; do sleep 5; echo "Waiting for API to be healthy..."; done'
              echo "‚úÖ Initial deployment completed successfully"
            else
              echo "üîÑ Existing deployment detected, performing zero-downtime update..."
              
              # Ensure deployment script exists and is executable
              if [ ! -f scripts/deploy-zero-downtime.sh ]; then
                echo "‚ùå Zero downtime deployment script not found!"
                exit 1
              fi
              
              # Set up environment
              export COMPOSE_FILE="docker-compose.testing.yml"
              export SERVICE_NAME="api"
              export HEALTH_CHECK_URL="http://localhost:3100/api/auth/ok"
              
              # Execute zero downtime deployment
              bash scripts/deploy-zero-downtime.sh
            fi
            
            # Verify final deployment state
            echo "üîç Verifying deployment..."
            docker compose -f docker-compose.testing.yml ps api
            
            # Test API endpoint
            echo "üß™ Testing API endpoint..."
            timeout 60 bash -c 'until curl -sf http://localhost:3100/api/auth/ok >/dev/null; do sleep 2; echo "Waiting for API to respond..."; done'
            
            echo "‚úÖ Zero downtime deployment completed successfully!"
          EOF
        shell: bash
        timeout-minutes: 20

      - name: Cleanup
        if: always()
        run: |
          rm -f $HOME/.ssh/id_ed25519
        shell: bash

      - name: Notify deployment result
        if: always()
        run: |
          if [ ${{ job.status }} = 'success' ]; then
            echo "‚úÖ Deployment to testing completed successfully"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
          else
            echo "‚ùå Deployment to testing failed"
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Check the logs above for details"
          fi
        shell: bash
