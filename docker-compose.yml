services:
  postgres:
    image: postgres:${POSTGRES_VERSION}
    container_name: ${POSTGRES_CONTAINER_NAME}
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - '${POSTGRES_PORT}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - gadain-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}']
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}

  redis:
    image: redis:${REDIS_VERSION}
    container_name: ${REDIS_CONTAINER_NAME}
    restart: unless-stopped
    ports:
      - '${REDIS_PORT}:6379'
    volumes:
      - redis_data:/data
    networks:
      - gadain-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}


  mail:
    image: ${MAIL_IMAGE}
    container_name: ${MAIL_CONTAINER_NAME}
    restart: unless-stopped
    ports:
      - '${MAIL_HTTP_PORT}:8025'  # Web UI
      - '${MAIL_SMTP_PORT}:1025'  # SMTP
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_FILE: ""
    volumes:
      - mailpit_data:/data
    networks:
      - gadain-network
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8025/api/v1/info']
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}

  vault:
    image: hashicorp/vault:latest
    container_name: ${VAULT_CONTAINER_NAME:-vault}
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    environment:
      VAULT_MODE: ${VAULT_MODE:-dev}
      VAULT_DEV_ROOT_TOKEN_ID: root
    command: >
      sh -c "
        if [ \"$${VAULT_MODE}\" = \"dev\" ]; then
          vault server -dev -dev-listen-address=0.0.0.0:8200
        else
          vault server -config=/vault-config.hcl
        fi
      "
    volumes:
      - ./vault-config.hcl:/vault-config.hcl
      - ${VAULT_DATA_VOLUME:-}:/vault/file

  minio:
    image: bitnami/minio:${MINIO_VERSION}
    container_name: ${MINIO_CONTAINER_NAME}
    restart: unless-stopped
    ports:
      - '${MINIO_PORT}:9000'        # API
      - '${MINIO_CONSOLE_PORT}:9001'  # Console UI
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_DEFAULT_BUCKETS: ${MINIO_DEFAULT_BUCKETS:-uploads}
      MINIO_SCHEME: ${MINIO_SCHEME:-http}
      MINIO_API_CORS_ALLOW_ORIGIN: ${MINIO_API_CORS_ALLOW_ORIGIN:-*}
    volumes:
      - minio_data:/bitnami/minio/data
    networks:
      - gadain-network
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:9000/minio/health/live || exit 1']
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}


volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  mailpit_data:
    driver: local
  minio_data:
    driver: local
  vault_data:
    driver: local

networks:
  gadain-network:
    driver: bridge