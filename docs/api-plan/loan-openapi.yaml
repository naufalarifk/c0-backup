openapi: 3.0.3
info:
  title: CryptoGadai Loan Management API
  version: 1.0.0
  description: |
    Complete API specification for the CryptoGadai loan management system.
    
    This API handles:
    - Loan offer creation and management
    - Loan application submission and tracking  
    - Loan lifecycle management (disbursement, repayment, liquidation)
    - LTV monitoring and valuation
    - Background processing workflows
    
servers:
  - url: https://api.cryptogadai.com/api
    description: Production server
  - url: https://cg-api.fh47.com/api
    description: Testing server
  - url: http://cg-api.localhost/api
    description: Local development server

security:
  - apiKeyCookie: []
  - bearerAuth: []

tags:
  - name: Loan Offers
    description: Lender loan offer management
  - name: Loan Applications
    description: Borrower loan application management
  - name: Loans
    description: Active loan contract management
  - name: Valuations
    description: LTV monitoring and collateral valuation

paths:
  # Loan Offers
  /loan-offers:
    post:
      tags: [Loan Offers]
      summary: Create new loan offer
      description: |
        Create a new loan offer with specified terms. The offer will be unpublished 
        until the principal funding invoice is paid.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLoanOfferRequest'
      responses:
        '201':
          description: Loan offer created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanOfferResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/InsufficientBalance'

    get:
      tags: [Loan Offers]
      summary: List available loan offers
      description: Retrieve paginated list of published loan offers available for matching
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - name: collateralBlockchainKey
          in: query
          schema:
            type: string
            description: Filter by collateral blockchain key
        - name: collateralTokenId
          in: query
          schema:
            type: string
            description: Filter by collateral token ID
        - name: principalBlockchainKey
          in: query
          schema:
            type: string
            description: Filter by principal blockchain key
        - name: principalTokenId
          in: query
          schema:
            type: string
            description: Filter by principal token ID
      responses:
        '200':
          description: List of loan offers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanOfferListResponse'

  /loan-offers/my-offers:
    get:
      tags: [Loan Offers]
      summary: Get my loan offers
      description: Retrieve all loan offers created by the authenticated lender
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Lender's loan offers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanOfferListResponse'

  /loan-offers/{id}:
    patch:
      tags: [Loan Offers]
      summary: Update loan offer
      description: Update loan offer status (pause, resume, close)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLoanOfferRequest'
      responses:
        '200':
          description: Loan offer updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanOfferResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # Loan Applications
  /loan-applications/calculate:
    post:
      tags: [Loan Applications]
      summary: Calculate loan application requirements
      description: |
        Calculate required collateral amount and generate preview for loan application
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoanCalculationRequest'
      responses:
        '200':
          description: Loan calculation results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanCalculationResponse'
        '400':
          $ref: '#/components/responses/ValidationError'

  /loan-applications:
    post:
      tags: [Loan Applications]
      summary: Create loan application
      description: |
        Create a new loan application. Requires collateral deposit to be published.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateLoanApplicationRequest'
      responses:
        '201':
          description: Loan application created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanApplicationResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          $ref: '#/components/responses/InsufficientBalance'

  /loan-applications/my-applications:
    get:
      tags: [Loan Applications]
      summary: Get my loan applications
      description: Retrieve all loan applications created by the authenticated borrower
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Borrower's loan applications
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanApplicationListResponse'

  /loan-applications/{id}:
    patch:
      tags: [Loan Applications]
      summary: Update loan application
      description: Update loan application (cancel, extend, modify terms)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateLoanApplicationRequest'
      responses:
        '200':
          description: Loan application updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanApplicationResponse'

  # Loans
  /loans:
    get:
      tags: [Loans]
      summary: List loans
      description: Get loans for authenticated user (as borrower or lender)
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
        - name: role
          in: query
          schema:
            type: string
            enum: [borrower, lender]
        - name: status
          in: query
          schema:
            type: string
            enum: [active, repaid, liquidated]
      responses:
        '200':
          description: List of loans
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanListResponse'

  /loans/{id}:
    get:
      tags: [Loans]
      summary: Get loan details
      description: Retrieve detailed information about a specific loan
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Loan details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanResponse'
        '404':
          $ref: '#/components/responses/NotFound'

  # Valuations
  /loans/{id}/valuations:
    get:
      tags: [Valuations]
      summary: Get loan valuation history
      description: Retrieve LTV ratio history for a loan
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Loan valuation history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoanValuationListResponse'

  # Early Liquidation
  /loans/{id}/early-liquidation/estimate:
    post:
      tags: [Loans]
      summary: Calculate early liquidation estimate
      description: |
        Calculate the estimated outcome of early liquidation for an active loan.
        
        This endpoint provides:
        - Current collateral valuation using latest exchange rates
        - Breakdown of all fees and costs involved
        - Estimated surplus or deficit after liquidation
        - Early liquidation fee calculation (1% of outstanding loan)
        
        **Requirements:**
        - Loan must be in 'Active' status
        - User must be the borrower of the loan
        - Current collateral valuation must be sufficient
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Loan ID to estimate early liquidation for
      responses:
        '200':
          description: Early liquidation estimate calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarlyLiquidationEstimateResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          description: User is not the borrower of this loan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          description: Loan not eligible for early liquidation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /loans/{id}/early-liquidation/request:
    post:
      tags: [Loans]
      summary: Request early liquidation
      description: |
        Submit a request for early liquidation of an active loan.
        
        **Process:**
        1. Validate loan eligibility and borrower ownership
        2. Calculate final liquidation amounts using current market rates
        3. Create liquidation record with 'Pending' status
        4. Queue liquidation processing for execution
        5. Send confirmation notification to borrower
        
        **Important Notes:**
        - Early liquidation fee: 1% of outstanding loan amount
        - All interest and origination fees are still charged in full
        - Any surplus after payment will be returned in USDT
        - Process is irreversible once submitted
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Loan ID to request early liquidation for
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EarlyLiquidationRequestPayload'
      responses:
        '201':
          description: Early liquidation request submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarlyLiquidationRequestResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          description: User is not the borrower of this loan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Early liquidation already in progress or loan not eligible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Loan not eligible for early liquidation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /loans/{id}/early-repayment/request:
    post:
      tags: [Loans]
      summary: Request early loan repayment
      description: |
        Submit a request for early repayment of an active loan before maturity date.
        
        **Process:**
        1. Validate loan eligibility and borrower ownership
        2. Calculate full repayment amount (no pro-rata interest reduction)
        3. Create repayment invoice for full amount
        4. Record repayment request with initiator='Borrower'
        5. Send repayment invoice to borrower
        
        **Payment Terms (per SRS BR-008):**
        - Principal: Full loan amount
        - Interest: Full interest amount (no reduction for early payment)
        - Origination Fee: Full 3% of principal amount
        - Early Payment Fee: NONE (no additional fee)
        - Total Payment = Principal + Full Interest + Origination Fee
        
        **Important Notes:**
        - No early payment fee or penalty applied
        - Interest is charged in full regardless of early payment
        - Origination fee is charged in full
        - Payment processed through standard invoice system
        - Process is irreversible once submitted
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: Loan ID to request early repayment for
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EarlyRepaymentRequestPayload'
      responses:
        '201':
          description: Early repayment request submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EarlyRepaymentRequestResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '403':
          description: User is not the borrower of this loan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Early repayment already in progress or loan not eligible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Loan not eligible for early repayment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    apiKeyCookie:
      type: apiKey
      in: cookie
      name: apiKeyCookie
      description: Better Auth API Key authentication via cookie
    bearerAuth:
      type: http
      scheme: bearer
      description: Better Auth Bearer token authentication

  parameters:
    Page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    # Loan Offer Schemas
    CreateLoanOfferRequest:
      type: object
      required:
        - principalBlockchainKey
        - principalTokenId
        - totalAmount
        - interestRate
        - termOptions
        - minLoanAmount
        - maxLoanAmount
        - liquidationMode
        - expirationDate
      properties:
        principalBlockchainKey:
          type: string
          description: Blockchain key for principal currency
          example: "eip155:1"
          maxLength: 64
        principalTokenId:
          type: string
          description: Token ID for principal currency
          example: "erc20:0xdac17f958d2ee523a2206206994597c13d831ec7"
          maxLength: 64
        totalAmount:
          type: string
          description: Total loan offer amount (18 decimal precision)
          pattern: '^\d+\.\d{18}$'
        interestRate:
          type: number
          description: Annual interest rate (percentage)
          minimum: 0
          maximum: 100
        termOptions:
          type: array
          items:
            type: integer
            enum: [1, 3, 6, 12]
        minLoanAmount:
          type: string
          description: Minimum loan amount (decimal places depending on principal currency)
          pattern: '^\d+\.\d{18}$'
        maxLoanAmount:
          type: string
          description: Maximum loan amount (decimal places depending on principal currency)
          pattern: '^\d+\.\d{18}$'
        liquidationMode:
          type: string
          enum: [Partial, Full]
        expirationDate:
          type: string
          format: date-time
          description: Optional expiration date for the offer

    UpdateLoanOfferRequest:
      type: object
      properties:
        action:
          type: string
          enum: [Close]
        closureReason:
          type: string

    LoanOfferResponse:
      type: object
      properties:
        id:
          type: string
        lenderId:
          type: string
        principalCurrency:
          $ref: '#/components/schemas/Currency'
        totalAmount:
          type: string
        availableAmount:
          type: string
        disbursedAmount:
          type: string
        interestRate:
          type: number
        termOptions:
          type: array
          items:
            type: integer
        status:
          type: string
          description: Current offer status (derived from time-based fields and business logic)
          enum: [Draft, Published, Closed]
          readOnly: true
          writeOnly: false
        createdDate:
          type: string
          format: date-time
        publishedDate:
          type: string
          format: date-time
        fundingInvoice:
          $ref: '#/components/schemas/Invoice'

    LoanOfferListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            offers:
              type: array
              items:
                $ref: '#/components/schemas/LoanOfferResponse'
            pagination:
              $ref: '#/components/schemas/PaginationMeta'

    # Loan Application Schemas
    LoanCalculationRequest:
      type: object
      required:
        - collateralBlockchainKey
        - collateralTokenId
        - principalBlockchainKey
        - principalTokenId
        - principalAmount
      properties:
        collateralBlockchainKey:
          type: string
          description: Blockchain key for collateral
          example: "eip155:1"
          maxLength: 64
        collateralTokenId:
          type: string
          description: Token ID for collateral
          example: "slip44:60"
          maxLength: 64
        principalBlockchainKey:
          type: string
          description: Blockchain key for principal currency
          example: "eip155:1"
          maxLength: 64
        principalTokenId:
          type: string
          description: Token ID for principal currency
          example: "erc20:0xdac17f958d2ee523a2206206994597c13d831ec7"
          maxLength: 64
        principalAmount:
          type: string
          pattern: '^\d+\.\d{18}$'

    LoanCalculationResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            requiredCollateralAmount:
              type: string
            exchangeRate:
              type: string

    CreateLoanApplicationRequest:
      type: object
      required:
        - collateralBlockchainKey
        - collateralTokenId
        - principalAmount
        - principalBlockchainKey
        - principalTokenId
        - maxInterestRate
        - termMonths
        - liquidationMode
      properties:
        collateralBlockchainKey:
          type: string
          description: Blockchain key for collateral
          example: "eip155:1"
          maxLength: 64
        collateralTokenId:
          type: string
          description: Token ID for collateral
          example: "slip44:60"
          maxLength: 64
        principalAmount:
          type: string
          pattern: '^\d+\.\d{18}$'
        principalBlockchainKey:
          type: string
          description: Blockchain key for principal currency
          example: "eip155:1"
          maxLength: 64
        principalTokenId:
          type: string
          description: Token ID for principal currency
          example: "erc20:0xdac17f958d2ee523a2206206994597c13d831ec7"
          maxLength: 64
        maxInterestRate:
          type: number
          minimum: 0
          maximum: 100
        termMonths:
          type: integer
          enum: [1, 3, 6, 12]
        liquidationMode:
          type: string
          enum: [Partial, Full]
        minLtvRatio:
          type: number
          minimum: 0
          maximum: 100

    UpdateLoanApplicationRequest:
      type: object
      properties:
        action:
          type: string
          enum: [Cancel]

    LoanApplicationResponse:
      type: object
      properties:
        id:
          type: string
        borrowerId:
          type: string
        collateralCurrency:
          type: string
        principalAmount:
          type: string
        status:
          type: string
          description: Current application status (derived from time-based fields and business logic)
          enum: [Draft, Published, Matched, Expired, Closed]
          readOnly: true
          writeOnly: false
        createdDate:
          type: string
          format: date-time
        publishedDate:
          type: string
          format: date-time
        expiryDate:
          type: string
          format: date-time
        collateralInvoice:
          $ref: '#/components/schemas/Invoice'

    LoanApplicationListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            applications:
              type: array
              items:
                $ref: '#/components/schemas/LoanApplicationResponse'
            pagination:
              $ref: '#/components/schemas/PaginationMeta'

    # Loan Schemas
    LoanResponse:
      type: object
      properties:
        id:
          type: string
        borrowerId:
          type: string
        lenderId:
          type: string
        principalCurrency:
          $ref: '#/components/schemas/Currency'
        principalAmount:
          type: string
        collateralCurrency:
          $ref: '#/components/schemas/Currency'
        collateralAmount:
          type: string
        interestRate:
          type: number
        termMonths:
          type: integer
        currentLtv:
          type: number
        maxLtvRatio:
          type: number
        status:
          type: string
          description: Current loan status (derived from time-based fields and business logic)
          enum: [Originated, Disbursed, Active, Repaid, Liquidated]
          readOnly: true
          writeOnly: false
        originationDate:
          type: string
          format: date-time
        disbursementDate:
          type: string
          format: date-time
        maturityDate:
          type: string
          format: date-time
        repaidDate:
          type: string
          format: date-time
        liquidationDate:
          type: string
          format: date-time
        repaymentInvoice:
          $ref: '#/components/schemas/Invoice'

    LoanListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            loans:
              type: array
              items:
                $ref: '#/components/schemas/LoanResponse'
            pagination:
              $ref: '#/components/schemas/PaginationMeta'

    # Valuation Schemas
    LoanValuationResponse:
      type: object
      properties:
        id:
          type: string
        loanId:
          type: string
        valuationDate:
          type: string
          format: date-time
        ltvRatio:
          type: number
        collateralValue:
          type: string
        exchangeRate:
          type: string

    LoanValuationListResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            valuations:
              type: array
              items:
                $ref: '#/components/schemas/LoanValuationResponse'
            pagination:
              $ref: '#/components/schemas/PaginationMeta'

    # Common Schemas
    Currency:
      type: object
      properties:
        blockchainKey:
          type: string
          description: CAIP-2 compliant blockchain identifier
          example: "eip155:1"
          maxLength: 64
        tokenId:
          type: string
          description: Token identifier within the blockchain
          example: "slip44:60"
          maxLength: 64
        name:
          type: string
          description: Human-readable currency name
          example: "Ethereum"
        symbol:
          type: string
          description: Currency symbol/ticker
          example: "ETH"
        decimals:
          type: integer
          description: Number of decimal places for precision
          example: 18
          minimum: 0
          maximum: 18
        logoUrl:
          type: string
          format: uri
          description: URL to currency logo image
          example: "https://assets.cryptogadai.com/currencies/eth.png"
      required:
        - currencyBlockchainKey
        - currencyTokenId
        - name
        - symbol
        - decimals

    Invoice:
      type: object
      properties:
        id:
          type: string
        amount:
          type: string
          description: Invoice amount with decimal precision
          pattern: '^\d+\.\d{18}$'
        currency:
          $ref: '#/components/schemas/Currency'
        walletAddress:
          type: string
          description: Payment wallet address
        expiryDate:
          type: string
          format: date-time
        # Status is derived from time-based fields
        paidDate:
          type: string
          format: date-time
          nullable: true
        expiredDate:
          type: string
          format: date-time
          nullable: true
      required:
        - id
        - amount
        - currency
        - walletAddress
        - expiryDate

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
          description: Current page number (1-based)
          example: 1
          minimum: 1
        limit:
          type: integer
          description: Number of items per page
          example: 20
          minimum: 1
          maximum: 100
        total:
          type: integer
          description: Total number of items across all pages
          example: 150
          minimum: 0
        totalPages:
          type: integer
          description: Total number of pages
          example: 8
          minimum: 0
        hasNext:
          type: boolean
          description: Whether there are more pages after current
          example: true
        hasPrev:
          type: boolean
          description: Whether there are pages before current
          example: false
      required:
        - page
        - limit
        - total
        - totalPages
        - hasNext
        - hasPrev

    # Early Liquidation Schemas
    EarlyLiquidationEstimateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            loanId:
              type: string
              description: Loan identifier
              example: "12345"
            currentValuation:
              $ref: '#/components/schemas/CollateralValuation'
            liquidationBreakdown:
              $ref: '#/components/schemas/LiquidationBreakdown'
            estimatedOutcome:
              type: object
              properties:
                totalLiquidationProceeds:
                  type: string
                  description: Total USDT from collateral liquidation
                  example: "12500.000000000000000000"
                  pattern: '^\d+\.\d{18}$'
                totalDeductions:
                  type: string
                  description: Total amount deducted (loan + interest + fees)
                  example: "10900.000000000000000000"
                  pattern: '^\d+\.\d{18}$'
                estimatedSurplus:
                  type: string
                  description: Estimated surplus returned to borrower in USDT
                  example: "1600.000000000000000000"
                  pattern: '^\d+\.\d{18}$'
                breakeven:
                  type: boolean
                  description: Whether liquidation will break even or result in deficit
                  example: true
            calculationDate:
              type: string
              format: date-time
              description: When this estimate was calculated
              example: "2025-08-13T15:30:00Z"
            disclaimers:
              type: array
              items:
                type: string
              description: Important disclaimers about the estimate
              example:
                - "Actual liquidation proceeds may vary due to market conditions"
                - "Exchange rates are subject to change until execution"
                - "Early liquidation fee of 1% is final and non-refundable"
      required:
        - success
        - data

    EarlyLiquidationRequestPayload:
      type: object
      properties:
        acknowledgment:
          type: boolean
          description: Borrower acknowledges terms and conditions
          example: true
        # [TBD] we don't do 2FA yet
        # twoFactorCode:
        #   type: string
        #   description: 2FA authentication code (if enabled)
        #   example: "123456"
        # confirmationMessage:
        #   type: string
        #   description: Confirmation message for irreversible action
        #   example: "I understand this action is irreversible and agree to proceed"
      required:
        - acknowledgment

    EarlyLiquidationRequestResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            liquidationId:
              type: string
              description: Unique liquidation request identifier
              example: "liq_67890"
            loanId:
              type: string
              description: Associated loan identifier
              example: "12345"
            status:
              type: string
              enum: [Pending, Processing, Fulfilled, Failed]
              description: Current liquidation status
              example: "Pending"
            submittedDate:
              type: string
              format: date-time
              description: When the liquidation request was submitted
              example: "2025-08-13T15:30:00Z"
            estimatedCompletionTime:
              type: string
              description: Estimated completion time for liquidation
              example: "2-4 hours"
            finalBreakdown:
              $ref: '#/components/schemas/LiquidationBreakdown'
            nextSteps:
              type: array
              items:
                type: string
              description: What happens next in the process
              example:
                - "Collateral will be liquidated on the market"
                - "Loan payment will be processed"
                - "Any surplus will be credited to your account"
                - "You will receive email confirmation when complete"
        message:
          type: string
          description: Confirmation message
          example: "Early liquidation request submitted successfully"
      required:
        - success
        - data
        - message

    # Early Repayment Schemas
    EarlyRepaymentRequestPayload:
      type: object
      properties:
        acknowledgment:
          type: boolean
          description: Borrower acknowledges terms and conditions
          example: true
        # [TBD] we don't do 2FA yet
        # twoFactorCode:
        #   type: string
        #   description: 2FA authentication code (if enabled)
        #   example: "123456"
        # confirmationMessage:
        #   type: string
        #   description: Confirmation message for repayment request
        #   example: "I understand I will pay the full interest and origination fee even for early repayment"
      required:
        - acknowledgment

    EarlyRepaymentRequestResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            repaymentId:
              type: string
              description: Unique repayment request identifier
              example: "rep_12345"
            loanId:
              type: string
              description: Associated loan identifier
              example: "12345"
            status:
              type: string
              enum: [Pending, Processing, Completed, Failed]
              description: Current repayment status
              example: "Pending"
            submittedDate:
              type: string
              format: date-time
              description: When the repayment request was submitted
              example: "2025-08-13T15:30:00Z"
            repaymentBreakdown:
              $ref: '#/components/schemas/RepaymentBreakdown'
            repaymentInvoice:
              $ref: '#/components/schemas/Invoice'
            nextSteps:
              type: array
              items:
                type: string
              description: What happens next in the process
              example:
                - "Payment invoice has been created"
                - "Pay the invoice to complete early repayment"
                - "Collateral will be released upon payment confirmation"
                - "You will receive email confirmation when complete"
        message:
          type: string
          description: Confirmation message
          example: "Early repayment request submitted successfully"
      required:
        - success
        - data
        - message

    RepaymentBreakdown:
      type: object
      properties:
        loanDetails:
          type: object
          properties:
            principalAmount:
              type: string
              description: Original loan principal
              example: "10000.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
            interestAmount:
              type: string
              description: Full interest amount (no reduction for early payment)
              example: "600.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
            originationFeeAmount:
              type: string
              description: Origination fee (3% of principal)
              example: "300.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
            totalRepaymentAmount:
              type: string
              description: Total repayment amount
              example: "10900.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
        paymentTerms:
          type: object
          properties:
            earlyPaymentFee:
              type: string
              description: Early payment fee (always 0 per SRS BR-008)
              example: "0.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
            interestReduction:
              type: string
              description: Interest reduction (always 0 per SRS BR-008)
              example: "0.000000000000000000"
              pattern: '^\\d+\\.\\d{18}$'
            paymentCurrency:
              $ref: '#/components/schemas/Currency'
        calculationDetails:
          type: object
          properties:
            originalTermMonths:
              type: integer
              description: Original loan term in months
              example: 6
            earlyPaymentAtMonth:
              type: integer
              description: Month when early payment is being made
              example: 3
            remainingTermMonths:
              type: integer
              description: Remaining months until maturity
              example: 3
            calculationDate:
              type: string
              format: date-time
              description: When this calculation was made
              example: "2025-08-13T15:30:00Z"
        disclaimers:
          type: array
          items:
            type: string
          description: Important disclaimers about early repayment
          example:
            - "Full interest amount is charged regardless of early payment"
            - "Origination fee (3% of principal) is charged in full"
            - "No early payment fee or penalty applies"
            - "Payment must be made in full to complete early repayment"
      required:
        - loanDetails
        - paymentTerms
        - calculationDetails

    LiquidationBreakdown:
      type: object
      properties:
        outstandingLoan:
          type: object
          properties:
            principalAmount:
              type: string
              description: Original loan principal
              example: "10000.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            interestAmount:
              type: string
              description: Total interest amount (full term)
              example: "600.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            originationFeeAmount:
              type: string
              description: Origination fee (3% of principal)
              example: "300.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            totalLoanRepayment:
              type: string
              description: Total loan repayment amount
              example: "10900.000000000000000000"
              pattern: '^\d+\.\d{18}$'
        liquidationFees:
          type: object
          properties:
            earlyLiquidationFee:
              type: string
              description: Early liquidation fee (1% of outstanding loan)
              example: "109.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            earlyLiquidationFeeRate:
              type: string
              description: Early liquidation fee rate
              example: "1.0"
            marketLiquidationFee:
              type: string
              description: Market execution fee
              example: "25.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            totalLiquidationFees:
              type: string
              description: Total liquidation fees
              example: "134.000000000000000000"
              pattern: '^\d+\.\d{18}$'
        totalDeductions:
          type: string
          description: Total amount to be deducted
          example: "11034.000000000000000000"
          pattern: '^\d+\.\d{18}$'
        calculationDetails:
          type: object
          properties:
            basedOnExchangeRate:
              type: string
              description: Exchange rate used for calculation
              example: "2500.000000000000000000"
            rateSource:
              type: string
              description: Source of exchange rate
              example: "coinbase"
            rateTimestamp:
              type: string
              format: date-time
              description: When the rate was retrieved
              example: "2025-08-13T15:29:45Z"
      required:
        - outstandingLoan
        - liquidationFees
        - totalDeductions
        - calculationDetails

    CollateralValuation:
      type: object
      properties:
        collateralCurrency:
          $ref: '#/components/schemas/Currency'
        currentAmount:
          type: string
          description: Current collateral amount
          example: "5.000000000000000000"
          pattern: '^\d+\.\d{18}$'
        currentMarketValue:
          type: object
          properties:
            amount:
              type: string
              description: Current market value in USDT
              example: "12500.000000000000000000"
              pattern: '^\d+\.\d{18}$'
            currency:
              $ref: '#/components/schemas/Currency'
            exchangeRate:
              type: string
              description: Current exchange rate (collateral/USDT)
              example: "2500.000000000000000000"
            rateSource:
              type: string
              description: Source of exchange rate
              example: "coinbase"
            rateTimestamp:
              type: string
              format: date-time
              description: When the rate was retrieved
              example: "2025-08-13T15:29:45Z"
        currentLtvRatio:
          type: string
          description: Current loan-to-value ratio
          example: "87.2"
        originalLtvRatio:
          type: string
          description: Original loan-to-value ratio at loan origination
          example: "70.0"
        ltvChange:
          type: object
          properties:
            percentage:
              type: string
              description: Change in LTV since origination
              example: "+17.2"
            direction:
              type: string
              enum: [improved, worsened, stable]
              description: Direction of LTV change
              example: "worsened"
      required:
        - collateralCurrency
        - currentAmount
        - currentMarketValue
        - currentLtvRatio
        - originalLtvRatio
        - ltvChange

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
              example: "VALIDATION_ERROR"
            message:
              type: string
              description: Human-readable error message
              example: "Request validation failed"
            details:
              type: object
              description: Additional error details
              additionalProperties: true
        timestamp:
          type: string
          format: date-time
          example: "2025-08-13T15:30:00Z"
        requestId:
          type: string
          format: uuid
          description: Request ID for tracking
      required:
        - success
        - error
        - timestamp

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: VALIDATION_ERROR
            requestId: req_abc123

    InsufficientBalance:
      description: Insufficient balance
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: INSUFFICIENT_BALANCE
            requestId: req_abc123

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: NOT_FOUND
            requestId: req_abc123
