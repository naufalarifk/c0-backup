openapi: 3.0.3
info:
  title: CryptoGadai User Profile Management API
  description: API specification for user profile management features including user type selection, profile updates, preferences, and institution memberships
  version: 2.0.0
  contact:
    name: CryptoGadai Development Team

servers:
  - url: https://api.cryptogadai.com
    description: Production server
  - url: https://cg-api.fh47.com
    description: Testing server
  - url: http://cg-api.localhost
    description: Local development server

security:
  - apiKeyCookie: []
  - bearerAuth: []

paths:
  # User Type Selection
  /api/users/type-selection:
    post:
      tags: [User Profile]
      summary: Select user type
      description: Mandatory user type selection after registration (Individual or Institution)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userType]
              properties:
                userType:
                  type: string
                  enum: [Individual, Institution]
                  description: User type selection
            examples:
              individual:
                summary: Select Individual user type
                value:
                  userType: Individual
              institution:
                summary: Select Institution user type
                value:
                  userType: Institution
      responses:
        '200':
          description: User type selected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  userType:
                    type: string
                    enum: [Individual, Institution]
                  message:
                    type: string
              examples:
                individual_selected:
                  summary: Individual type selected
                  value:
                    userType: Individual
                    message: User type Individual successfully selected
                institution_selected:
                  summary: Institution type selected
                  value:
                    userType: Institution
                    message: User type Institution successfully selected
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: User type already selected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                already_selected:
                  summary: User type already selected
                  value:
                    success: false
                    error:
                      code: CONFLICT
                      message: User type already selected
                    timestamp: 2024-03-15T10:30:00Z
                    requestId: req_123e4567-e89b-12d3-a456-426614174000

  # User Profile Management
  /api/users/profile:
    get:
      tags: [User Profile]
      summary: Get user profile
      description: Retrieves user profile information and available actions
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/UserProfile'
              examples:
                individual_user:
                  summary: Individual user profile with verified KYC
                  value:
                    user:
                      id: 12345
                      role: User
                      email: john.doe@example.com
                      emailVerifiedDate: 2024-01-15T10:30:00Z
                      name: John Doe
                      profilePictureUrl: https://storage.cryptogadai.com/profiles/12345.jpg
                      googleId: null
                      userType: Individual
                      kycId: 567
                      kycStatus: verified
                      isVerified: true
                      phoneNumberVerified: true
                      institutionId: null
                      institutionRole: null
                      twoFaEnabled: false
                      createdDate: 2024-01-10T08:00:00Z
                      lastLoginDate: 2024-03-15T14:20:00Z
                institution_owner:
                  summary: Institution owner profile
                  value:
                    user:
                      id: 98765
                      role: User
                      email: ceo@techcorp.com
                      emailVerifiedDate: 2024-02-01T09:15:00Z
                      name: Jane Smith
                      profilePictureUrl: https://storage.cryptogadai.com/profiles/98765.jpg
                      googleId: google_123456789
                      userType: Institution
                      kycId: null
                      kycStatus: none
                      institutionId: 98765
                      institutionRole: Owner
                      twoFaEnabled: true
                      createdDate: 2024-01-20T10:00:00Z
                      lastLoginDate: 2024-03-15T16:45:00Z
                new_user_no_type:
                  summary: New user without type selection
                  value:
                    user:
                      id: 54321
                      role: User
                      email: newuser@example.com
                      emailVerifiedDate: 2024-03-14T12:00:00Z
                      name: Alex Johnson
                      profilePictureUrl: null
                      googleId: null
                      userType: null
                      kycId: null
                      kycStatus: none
                      isVerified: false
                      verificationLevel: unverified
                      phoneNumberVerified: false
                      featureUnlockStatus:
                        tradingEnabled: false
                        withdrawalEnabled: false
                        loanBorrowingEnabled: false
                        loanLendingEnabled: false
                        institutionalFeaturesEnabled: false
                      requiredVerifications:
                        - type: phone
                          title: "Complete your verification to unlock features"
                          description: "Complete phone verification to unlock all platform features"
                          actionText: "Verify Now"
                          priority: high
                        - type: kyc
                          title: "Complete your verification to unlock features"
                          description: "Complete KYC verification to access trading and lending features"
                          actionText: "Verify Now"
                          priority: critical
                      institutionId: null
                      institutionRole: null
                      twoFaEnabled: false
                      createdDate: 2024-03-14T12:00:00Z
                      lastLoginDate: 2024-03-15T09:30:00Z
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags: [User Profile]
      summary: Update user profile
      description: Updates user profile information and optionally profile picture
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 160
                profilePicture:
                  type: string
                  format: binary
                  description: Image file, max 5MB
            examples:
              name_only:
                summary: Update name only
                value:
                  name: John Michael Doe
              with_picture:
                summary: Update name and profile picture
                value:
                  name: John Michael Doe
                  profilePicture: [Binary image data]
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    type: object
                    properties:
                      name:
                        type: string
                      profilePictureUrl:
                        type: string
                  message:
                    type: string
              examples:
                name_updated:
                  summary: Name updated successfully
                  value:
                    user:
                      name: John Michael Doe
                      profilePictureUrl: https://storage.cryptogadai.com/profiles/12345.jpg
                    message: Profile updated successfully
                picture_updated:
                  summary: Name and picture updated
                  value:
                    user:
                      name: John Michael Doe
                      profilePictureUrl: https://storage.cryptogadai.com/profiles/12345_new.jpg
                    message: Profile updated successfully
        '400':
          $ref: '#/components/responses/ValidationError'
        '413':
          $ref: '#/components/responses/FileTooLarge'

  /api/users/preferences:
    get:
      tags: [User Profile]
      summary: Get user preferences
      description: |
        Retrieve user preferences including notification settings, display preferences,
        and privacy configurations for the authenticated user.

        **Preference Categories:**
        - Notifications: Email, push, and SMS notification preferences
        - Display: Theme, language, and currency display settings
        - Privacy: Profile visibility and data sharing preferences
      responses:
        '200':
          description: User preferences retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferencesResponse'
              examples:
                default_preferences:
                  summary: Default user preferences
                  value:
                    success: true
                    data:
                      notifications:
                        email:
                          enabled: true
                          types:
                            paymentAlerts: true
                            loanUpdates: true
                            systemNotifications: true
                            marketingCommunications: false
                        push:
                          enabled: true
                          types:
                            paymentAlerts: true
                            loanUpdates: false
                            systemNotifications: true
                            marketingCommunications: false
                        sms:
                          enabled: false
                          types:
                            paymentAlerts: false
                            loanUpdates: false
                            systemNotifications: false
                            marketingCommunications: false
                      display:
                        theme: "light"
                        language: "en"
                        currency: "USD"
                        timezone: "UTC"
                        dateFormat: "YYYY-MM-DD"
                        numberFormat: "en-US"
                      privacy:
                        profileVisibility: "private"
                        dataSharing:
                          analytics: true
                          thirdPartyIntegrations: false
                          marketResearch: false
                        activityTracking: true
                custom_preferences:
                  summary: Customized user preferences
                  value:
                    success: true
                    data:
                      notifications:
                        email:
                          enabled: true
                          types:
                            paymentAlerts: true
                            loanUpdates: true
                            systemNotifications: false
                            marketingCommunications: true
                        push:
                          enabled: false
                          types:
                            paymentAlerts: false
                            loanUpdates: false
                            systemNotifications: false
                            marketingCommunications: false
                        sms:
                          enabled: true
                          types:
                            paymentAlerts: true
                            loanUpdates: false
                            systemNotifications: false
                            marketingCommunications: false
                      display:
                        theme: "dark"
                        language: "id"
                        currency: "IDR"
                        timezone: "Asia/Jakarta"
                        dateFormat: "YYYY-MM-DD"
                        numberFormat: "id-ID"
                      privacy:
                        profileVisibility: "public"
                        dataSharing:
                          analytics: true
                          thirdPartyIntegrations: true
                          marketResearch: true
                        activityTracking: true
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags: [User Profile]
      summary: Update user preferences
      description: |
        Update user preferences including notification settings, display preferences,
        and privacy configurations for the authenticated user.

        **Update Behavior:**
        - Partial updates supported - only provided fields will be updated
        - Nested objects are merged, not replaced entirely
        - Invalid preference values are rejected with validation errors
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserPreferencesUpdateRequest'
            examples:
              notification_update:
                summary: Update notification preferences only
                value:
                  notifications:
                    email:
                      enabled: false
                    push:
                      enabled: true
                      types:
                        paymentAlerts: true
                        systemNotifications: false
              display_update:
                summary: Update display preferences
                value:
                  display:
                    theme: "dark"
                    language: "fr"
                    currency: "EUR"
              privacy_update:
                summary: Update privacy settings
                value:
                  privacy:
                    profileVisibility: "private"
                    dataSharing:
                      analytics: false
                      thirdPartyIntegrations: false
              full_update:
                summary: Comprehensive preferences update
                value:
                  notifications:
                    email:
                      enabled: true
                      types:
                        paymentAlerts: true
                        loanUpdates: true
                        systemNotifications: true
                        marketingCommunications: false
                    sms:
                      enabled: true
                      types:
                        paymentAlerts: true
                  display:
                    theme: "dark"
                    language: "en"
                    currency: "USD"
                  privacy:
                    profileVisibility: "private"
                    dataSharing:
                      analytics: true
                      thirdPartyIntegrations: false
      responses:
        '200':
          description: User preferences updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPreferencesResponse'
              examples:
                preferences_updated:
                  summary: Preferences successfully updated
                  value:
                    success: true
                    data:
                      notifications:
                        email:
                          enabled: false
                          types:
                            paymentAlerts: true
                            loanUpdates: true
                            systemNotifications: true
                            marketingCommunications: false
                        push:
                          enabled: true
                          types:
                            paymentAlerts: true
                            loanUpdates: false
                            systemNotifications: false
                            marketingCommunications: false
                        sms:
                          enabled: false
                          types:
                            paymentAlerts: false
                            loanUpdates: false
                            systemNotifications: false
                            marketingCommunications: false
                      display:
                        theme: "light"
                        language: "en"
                        currency: "USD"
                        timezone: "UTC"
                        dateFormat: "YYYY-MM-DD"
                        numberFormat: "en-US"
                      privacy:
                        profileVisibility: "private"
                        dataSharing:
                          analytics: true
                          thirdPartyIntegrations: false
                          marketResearch: false
                        activityTracking: true
        '400':
          description: Validation error in preferences data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_theme:
                  summary: Invalid theme value
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Invalid theme value"
                invalid_language:
                  summary: Unsupported language
                  value:
                    success: false
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Unsupported language"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/user/institutions:
    get:
      tags: [User Profile]
      summary: Get user's institution memberships
      description: Retrieves user's current institution membership and role information
      responses:
        '200':
          description: User institution memberships retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  memberships:
                    type: array
                    items:
                      type: object
                      properties:
                        institution:
                          $ref: '#/components/schemas/Institution'
                        role:
                          type: string
                          enum: [Owner, Finance]
                        joinedAt:
                          type: string
                          format: date-time
                        verificationStatus:
                          type: string
                          enum: [Verified, Pending, Unverified]
              examples:
                institution_owner:
                  summary: User is institution owner
                  value:
                    memberships:
                      - institution:
                          id: 98765
                          name: PT Teknologi Nusantara
                          type: PT
                          verificationStatus: Verified
                          memberCount: 5
                          activeSince: 2024-01-20T10:00:00Z
                        role: Owner
                        joinedAt: 2024-01-20T10:00:00Z
                        verificationStatus: Verified
                individual_user:
                  summary: Individual user with no institution
                  value:
                    memberships: []
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    apiKeyCookie:
      type: apiKey
      in: cookie
      name: apiKeyCookie
      description: Better Auth API Key authentication via cookie
    bearerAuth:
      type: http
      scheme: bearer
      description: Better Auth Bearer token authentication

  schemas:
    UserProfile:
      type: object
      description: User Profile
      properties:
        id:
          type: integer
          format: int64
        role:
          type: string
          enum: [User]
        email:
          type: string
          format: email
          nullable: true
        emailVerifiedDate:
          type: string
          format: date-time
          nullable: true
        name:
          type: string
          nullable: true
        profilePictureUrl:
          type: string
          nullable: true
        googleId:
          type: string
          nullable: true
        userType:
          type: string
          enum: [Individual, Institution]
          description: User type selection (mandatory after registration)
          nullable: true
        kycId:
          type: integer
          format: int64
          nullable: true
        kycStatus:
          type: string
          enum: [none, pending, verified, rejected]
          description: Current KYC status
        isVerified:
          type: boolean
          description: Overall verification status for display badges (computed from KYC and institution status)
        verificationLevel:
          type: string
          enum: [verified, unverified, pending, rejected]
          description: Standardized verification level for UI badges
        phoneNumberVerified:
          type: boolean
          description: Phone number verification status (addresses audit discrepancy D03)
        featureUnlockStatus:
          type: object
          description: Feature availability status based on user verification level
          properties:
            tradingEnabled:
              type: boolean
              description: Whether trading features are enabled
            withdrawalEnabled:
              type: boolean
              description: Whether withdrawal features are enabled
            loanBorrowingEnabled:
              type: boolean
              description: Whether loan borrowing features are enabled
            loanLendingEnabled:
              type: boolean
              description: Whether loan lending features are enabled
            institutionalFeaturesEnabled:
              type: boolean
              description: Whether institutional features are enabled
        requiredVerifications:
          type: array
          description: List of verifications still required (addresses audit discrepancy D03)
          items:
            type: object
            properties:
              type:
                type: string
                enum: [email, phone, kyc, institution]
                description: Type of verification required
              title:
                type: string
                description: Display title for verification requirement
                example: "Complete your verification to unlock features"
              description:
                type: string
                description: Detailed description of what needs to be verified
                example: "Complete phone verification to unlock all platform features"
              actionText:
                type: string
                description: Text for action button
                example: "Verify Now"
              priority:
                type: string
                enum: [low, medium, high, critical]
                description: Priority level of this verification
        institutionId:
          type: integer
          format: int64
          nullable: true
        institutionRole:
          type: string
          enum: [Owner, Finance]
          nullable: true
        twoFaEnabled:
          type: boolean
        createdDate:
          type: string
          format: date-time
        lastLoginDate:
          type: string
          format: date-time
          nullable: true

    Institution:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          description: Business name of the institution
        type:
          type: string
          description: Business type (e.g., PT, CV, UD)
        verificationStatus:
          type: string
          enum: [Verified, Pending, Unverified]
          description: Current verification status
        memberCount:
          type: integer
          description: Number of active members
          minimum: 0
        activeSince:
          type: string
          format: date-time
          description: Date when institution was approved/activated
        registrationDetails:
          type: object
          properties:
            npwpNumber:
              type: string
              description: NPWP tax identification number
            registrationNumber:
              type: string
              description: Business registration number (NIB/TDP)
            businessType:
              type: string
              description: Legal business entity type

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              description: Error code
              example: VALIDATION_ERROR
            message:
              type: string
              description: Human-readable error message
              example: Request validation failed
            details:
              type: object
              description: Additional error details
              additionalProperties: true
        timestamp:
          type: string
          format: date-time
          example: 2025-08-13T15:30:00Z
        requestId:
          type: string
          format: uuid
          description: Request ID for tracking
      required:
        - success
        - error
        - timestamp

    UserPreferencesResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/UserPreferences'

    UserPreferences:
      type: object
      properties:
        notifications:
          $ref: '#/components/schemas/NotificationPreferences'
        display:
          $ref: '#/components/schemas/DisplayPreferences'
        privacy:
          $ref: '#/components/schemas/PrivacyPreferences'

    UserPreferencesUpdateRequest:
      type: object
      properties:
        notifications:
          $ref: '#/components/schemas/NotificationPreferences'
        display:
          $ref: '#/components/schemas/DisplayPreferences'
        privacy:
          $ref: '#/components/schemas/PrivacyPreferences'

    NotificationPreferences:
      type: object
      properties:
        email:
          $ref: '#/components/schemas/NotificationChannelSettings'
        push:
          $ref: '#/components/schemas/NotificationChannelSettings'
        sms:
          $ref: '#/components/schemas/NotificationChannelSettings'

    NotificationChannelSettings:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether this notification channel is enabled
          example: true
        types:
          type: object
          properties:
            paymentAlerts:
              type: boolean
              description: Payment due and overdue alerts
              example: true
            loanUpdates:
              type: boolean
              description: Loan status and lifecycle updates
              example: true
            systemNotifications:
              type: boolean
              description: System maintenance and security alerts
              example: true
            marketingCommunications:
              type: boolean
              description: Marketing and promotional content
              example: false

    DisplayPreferences:
      type: object
      properties:
        theme:
          type: string
          enum: [light, dark]
          description: UI theme preference
          example: "light"
        language:
          type: string
          enum: [en, id]
          description: Display language
          example: "en"
        currency:
          type: string
          enum: [USD, IDR, EUR, BTC, ETH]
          description: Preferred display currency
          example: "USD"
        timezone:
          type: string
          description: User timezone (IANA format)
          example: "UTC"
        dateFormat:
          type: string
          enum: [YYYY-MM-DD]
          description: Date display format
          example: "YYYY-MM-DD"
        numberFormat:
          type: string
          description: Number formatting locale
          example: "en-US"

    PrivacyPreferences:
      type: object
      properties:
        profileVisibility:
          type: string
          enum: [private, public]
          description: Profile visibility setting
          example: "private"
        dataSharing:
          type: object
          properties:
            analytics:
              type: boolean
              description: Allow anonymous analytics data collection
              example: true
            thirdPartyIntegrations:
              type: boolean
              description: Allow data sharing with approved third parties
              example: false
            marketResearch:
              type: boolean
              description: Participate in market research studies
              example: false
        activityTracking:
          type: boolean
          description: Allow platform activity tracking for personalization
          example: true

    PortfolioAnalytics:
      type: object
      properties:
        totalPortfolioValue:
          type: object
          properties:
            amount:
              type: string
              description: Total portfolio value in USD
              example: 125000.50
            currency:
              type: string
              example: USD
            lastUpdated:
              type: string
              format: date-time
        performanceMetrics:
          type: object
          properties:
            dailyChange:
              type: object
              properties:
                amount:
                  type: string
                  example: 1234.56
                percentage:
                  type: number
                  example: 5.2
            weeklyTrend:
              type: array
              items:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                  value:
                    type: string
        assetBreakdown:
          type: object
          properties:
            cryptoAssets:
              type: object
              properties:
                percentage:
                  type: number
                  example: 70.0
                value:
                  type: string
                  example: 87500.00
            stablecoins:
              type: object
              properties:
                percentage:
                  type: number
                  example: 20.0
                value:
                  type: string
                  example: 25000.00
            activeLoanCollateral:
              type: object
              properties:
                percentage:
                  type: number
                  example: 10.0
                value:
                  type: string
                  example: 12500.00
        loanMetrics:
          type: object
          properties:
            activeBorrowedLoans:
              type: object
              properties:
                count:
                  type: integer
                  example: 3
                totalPrincipal:
                  type: string
                  example: 50000.00
                totalCollateral:
                  type: string
                  example: 65000.00
                averageLTV:
                  type: number
                  example: 0.77
            activeLentLoans:
              type: object
              properties:
                count:
                  type: integer
                  example: 5
                totalPrincipal:
                  type: string
                  example: 75000.00
                expectedInterest:
                  type: string
                  example: 6750.00

    Currency:
      type: object
      properties:
        blockchainKey:
          type: string
          description: CAIP-2 compliant blockchain identifier
          example: eip155:1
          maxLength: 64
        tokenId:
          type: string
          description: Token identifier within the blockchain
          example: slip44:60
          maxLength: 64
        name:
          type: string
          description: Human-readable currency name
          example: Ethereum
        symbol:
          type: string
          description: Currency symbol/ticker
          example: ETH
        decimals:
          type: integer
          description: Number of decimal places for precision
          example: 18
          minimum: 0
          maximum: 18
        logoUrl:
          type: string
          format: uri
          description: URL to currency logo image
          example: https://assets.cryptogadai.com/currencies/eth.png
      required:
        - blockchainKey
        - tokenId
        - name
        - symbol
        - decimals

  responses:
    Unauthorized:
      description: Authentication required or token invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: INVALID_TOKEN
            message: Token expired or invalid

    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            profile_validation_error:
              summary: Profile update validation error
              value:
                success: false
                error:
                  code: VALIDATION_ERROR
                  message: Request validation failed
                  details:
                    name: Name cannot exceed 160 characters
                    profilePicture: File must be an image (JPEG, PNG, GIF)
                timestamp: 2024-03-15T10:30:00Z
                requestId: req_123e4567-e89b-12d3-a456-426614174001

    FileTooLarge:
      description: File exceeds size limit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: FILE_TOO_LARGE
            message: Profile picture must be under 5MB

tags:
  - name: User Profile
    description: User profile management and updates
